<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="S.Akai"><title>如何使用CORS进行跨域 · S.Akai</title><meta name="description" content="关于CORS，有很多的文章已经说得很清楚了，可以参考：https://developer.mozilla.org/en-US/docs/Web/HTTP/CORShttps://developer.mozilla.org/en-US/docs/Web/HTTP/Server-Side_Access_"><meta name="keywords" content="S.Akai, 音樂, 日劇, web開發,部落格，博客"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="google-site-verification" content="EoyjLufosvy0SbD-iVe-DFl2wvMlOYmu9Cq01LnJ7Dw"><meta name="generator" content="Hexo 4.2.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/profile.jpg"><h3 title=""><a href="/">S.Akai</a></h3><h5 title=""><a href="/"></a></h5><div class="description"><div class="widget-wrap"><div class="widget tagcloud"><a href="/tags/English/" style="font-size: 10px;">English</a> <a href="/tags/code/" style="font-size: 15px;">code</a> <a href="/tags/%E5%8A%A8%E6%BC%AB/" style="font-size: 10px;">动漫</a> <a href="/tags/%E5%B1%95%E8%A7%88/" style="font-size: 10px;">展览</a> <a href="/tags/%E5%BF%83%E6%83%85/" style="font-size: 10px;">心情</a> <a href="/tags/%E6%97%A5%E5%89%A7/" style="font-size: 15px;">日剧</a> <a href="/tags/%E6%97%A5%E5%B8%B8/" style="font-size: 15px;">日常</a> <a href="/tags/%E7%94%B5%E5%BD%B1/" style="font-size: 10px;">电影</a> <a href="/tags/%E8%B4%B4%E5%A3%AB/" style="font-size: 10px;">贴士</a> <a href="/tags/%E9%9F%B3%E4%B9%90/" style="font-size: 20px;">音乐</a> <a href="/tags/%E9%A3%9F%E9%A5%AD/" style="font-size: 10px;">食饭</a></div></div></div></div></div><ul class="social-links"><li><a href="https://twitter.com/soul_dough" target="_blank" rel="noopener"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/souldough" target="_blank" rel="noopener"><i class="fa fa-weibo"></i></a></li></ul></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/cv">CV</a></li><li><a href="/archives">Archive</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/profile.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>如何使用CORS进行跨域</a></h3></div><div class="post-content"><p>关于CORS，有很多的文章已经说得很清楚了，可以参考：<br><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Server-Side_Access_Control" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/HTTP/Server-Side_Access_Control</a><br><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2016/04/cors.html</a></p>
<p>本文主要关于CORS的具体实现，和一些具体注意事项：</p>
<p>本次将使用npm module下的CORS包，可以先<code>npm install CORS</code>安装</p>
<p>在添加一个文件<code>cors.js</code>,添加如下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">'cors'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> whiteList = [<span class="string">'http://localhost:3000'</span>, <span class="string">'https://localhost:3433'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> corsOptions = <span class="function"><span class="keyword">function</span>(<span class="params">req, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _options</span><br><span class="line">  <span class="keyword">if</span>(req.headers.origin &amp;&amp; whiteList.indexOf(req.headers.origin) != <span class="number">-1</span>) &#123;</span><br><span class="line">    _options = &#123;<span class="attr">origin</span>: <span class="literal">true</span>&#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    _options = &#123;<span class="attr">origin</span>: <span class="literal">false</span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  callback(<span class="literal">null</span>, _options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">exports.corsWithOption = cors(corsOptions)</span><br><span class="line">exports.cors = cors()</span><br></pre></td></tr></table></figure>

<p>上面的代码中，我们通过异步的方式来动态设置CORS的选项，当headers中的origin在白名单中时，我们就将添加Access-Control-Allow-Origin的header，并且其值会设为request header当中的origin值，否则将不设置CORS header。</p>
<p>我们同时输出默认的cors方法，其会自动设置<code>Access-Control-Allow-Origin：*</code>。</p>
<p>值得注意的是CORS是协议，主流的浏览器对CORS header都是支持的，在需要CORS的时候，浏览器会自动设置request header使得request可以符合CORS的规范，但是当用postman进行测试时，需要单独在header中设置相关的header，比如需要添加origin的header为在白名单中的地址。另外我们也可以看到即使origin设置成白名单之外的值，所做的CRUD操作依然会成功执行，这是因为postman并不执行CORS的标准。</p>
<p>如果要在postman模拟浏览器的行为，可以将<code>corsOption</code>替换为:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> corsOptions =  &#123;</span><br><span class="line">  origin: <span class="function"><span class="keyword">function</span>(<span class="params">origin, cb</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!origin) &#123;</span><br><span class="line">      <span class="keyword">return</span> cb(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'no origin is present'</span>), <span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(whiteList.indexOf(origin) !== <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> cb(<span class="literal">null</span>, <span class="literal">true</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> cb(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'The CORS policy for this site does not allow access from the specified Origin.'</span>), <span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时的Access-Control-Allow-Origin只会设置为固定的值，并且在不允许CORS的情况下直接进行报错。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-05-24</span><i class="fa fa-comment-o"></i><a href="/2018/05/24/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8CORS%E8%BF%9B%E8%A1%8C%E8%B7%A8%E5%9F%9F/#comments">Comments</a><i class="fa fa-tag"></i><a class="tag" href="/tags/code/" title="code">code </a></div></div></div></div><div class="post-copyright"><li class="post-copyright-author"><strong>本文作者：灵魂面团</strong></li><li class="post-copyright-link"> <strong>本文链接：https://hypster.github.io/2018/05/24/如何使用CORS进行跨域/</strong></li><li class="post-copyright-license"><strong>版权声明：</strong><a rel="license noopener" href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png"></a>本作品采用<a rel="license noopener" href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。</li></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,https://hypster.github.io/2018/05/24/如何使用CORS进行跨域/,S.Akai,如何使用CORS进行跨域,;" target="_blank" rel="noopener"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2018/05/24/%E5%A6%82%E4%BD%95%E5%AD%A6%E4%B9%A0%E9%9F%B3%E4%B9%90/" title="如何学习音乐">prev post</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2018/05/20/%E8%A7%82%E7%9C%8B%E7%94%B5%E5%BD%B1%E3%80%8C%E6%98%BC%E9%A2%9C%E3%80%8D%E5%BC%95%E5%8F%91%E7%9A%84%E4%B8%80%E4%BA%9B%E6%9D%82%E6%84%9F/" title="观看电影「昼颜」引发的一些杂感">next post</a></li></ul></div><a id="comments"></a><div id="disqus_thread"></div><script>var disqus_shortname = 'hypster';
var disqus_identifier = '2018/05/24/如何使用CORS进行跨域/';
var disqus_title = '如何使用CORS进行跨域';
var disqus_url = 'https://hypster.github.io/2018/05/24/如何使用CORS进行跨域/';
var disqus_config = function () {
  this.page.url = 'https://hypster.github.io/2018/05/24/如何使用CORS进行跨域/';; // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = '2018/05/24/如何使用CORS进行跨域/';; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    dsq.setAttribute('data-timestamp', +new Date());
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>